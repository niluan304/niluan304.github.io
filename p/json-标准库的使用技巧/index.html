<!doctype html><html lang=zh-cn dir=ltr><head><meta charset=utf-8><meta name=viewport content='width=device-width,initial-scale=1'><meta name=description content='encoding/json/v2 即将在 go1.25 作为实验特性推出，真的非常让人期待。笔者回顾日常开发中，对 v1(encoding/json) 的使用，顺势总结了一些的技巧，而经过测试，这些技巧在 encoding/json/v2 仍然是有效的，这同样让笔者非常开心。
关于 v2 的相关介绍，可查看：手把手带你玩转GOEXPERIMENT=jsonv2：Go下一代JSON库初探 | Tony Bai
基本的序列化和反序列化 先简单回顾下 JSON 这种数据交换格式在 go 中的使用：
type User struct { UserId int64 `json:&amp;#34;userId&amp;#34;` Password string `json:&amp;#34;password&amp;#34;` Birthday time.Time `json:&amp;#34;birthday&amp;#34;` } func main() { user := User{ UserId: 20060102150405, Password: &amp;#34;zwei&amp;#34;, Birthday: time.Unix(1136214245, 0), } data, _ := json.Marshal(user) fmt.Println(string(data)) // {&amp;#34;userId&amp;#34;:20060102150405,&amp;#34;password&amp;#34;:&amp;#34;zwei&amp;#34;,&amp;#34;birthday&amp;#34;:&amp;#34;2006-01-02T15:04:05Z&amp;#34;} } 通过 tag 为结构体字段编写元信息，这是 go 语言的语法，并在运行时通过反射解析。
json tag 的编写规则 标准库 encoding/json 规定了 json tag 的编写规则：'><title>JSON 标准库的使用技巧</title>
<link rel=canonical href=https://niluan304.github.io/p/json-%E6%A0%87%E5%87%86%E5%BA%93%E7%9A%84%E4%BD%BF%E7%94%A8%E6%8A%80%E5%B7%A7/><link rel=stylesheet href=/scss/style.min.545a4bdeec1c4e1219ce37a5aa3c203d9c43cc628e61f46f1be508672511f8d8.css><meta property='og:title' content='JSON 标准库的使用技巧'><meta property='og:description' content='encoding/json/v2 即将在 go1.25 作为实验特性推出，真的非常让人期待。笔者回顾日常开发中，对 v1(encoding/json) 的使用，顺势总结了一些的技巧，而经过测试，这些技巧在 encoding/json/v2 仍然是有效的，这同样让笔者非常开心。
关于 v2 的相关介绍，可查看：手把手带你玩转GOEXPERIMENT=jsonv2：Go下一代JSON库初探 | Tony Bai
基本的序列化和反序列化 先简单回顾下 JSON 这种数据交换格式在 go 中的使用：
type User struct { UserId int64 `json:&amp;#34;userId&amp;#34;` Password string `json:&amp;#34;password&amp;#34;` Birthday time.Time `json:&amp;#34;birthday&amp;#34;` } func main() { user := User{ UserId: 20060102150405, Password: &amp;#34;zwei&amp;#34;, Birthday: time.Unix(1136214245, 0), } data, _ := json.Marshal(user) fmt.Println(string(data)) // {&amp;#34;userId&amp;#34;:20060102150405,&amp;#34;password&amp;#34;:&amp;#34;zwei&amp;#34;,&amp;#34;birthday&amp;#34;:&amp;#34;2006-01-02T15:04:05Z&amp;#34;} } 通过 tag 为结构体字段编写元信息，这是 go 语言的语法，并在运行时通过反射解析。
json tag 的编写规则 标准库 encoding/json 规定了 json tag 的编写规则：'><meta property='og:url' content='https://niluan304.github.io/p/json-%E6%A0%87%E5%87%86%E5%BA%93%E7%9A%84%E4%BD%BF%E7%94%A8%E6%8A%80%E5%B7%A7/'><meta property='og:site_name' content='雾封的笔'><meta property='og:type' content='article'><meta property='article:section' content='Post'><meta property='article:published_time' content='2025-03-09T13:23:15+08:00'><meta property='article:modified_time' content='2025-03-09T13:23:15+08:00'><meta name=twitter:title content="JSON 标准库的使用技巧"><meta name=twitter:description content="encoding/json/v2 即将在 go1.25 作为实验特性推出，真的非常让人期待。笔者回顾日常开发中，对 v1(encoding/json) 的使用，顺势总结了一些的技巧，而经过测试，这些技巧在 encoding/json/v2 仍然是有效的，这同样让笔者非常开心。
关于 v2 的相关介绍，可查看：手把手带你玩转GOEXPERIMENT=jsonv2：Go下一代JSON库初探 | Tony Bai
基本的序列化和反序列化 先简单回顾下 JSON 这种数据交换格式在 go 中的使用：
type User struct { UserId int64 `json:&amp;#34;userId&amp;#34;` Password string `json:&amp;#34;password&amp;#34;` Birthday time.Time `json:&amp;#34;birthday&amp;#34;` } func main() { user := User{ UserId: 20060102150405, Password: &amp;#34;zwei&amp;#34;, Birthday: time.Unix(1136214245, 0), } data, _ := json.Marshal(user) fmt.Println(string(data)) // {&amp;#34;userId&amp;#34;:20060102150405,&amp;#34;password&amp;#34;:&amp;#34;zwei&amp;#34;,&amp;#34;birthday&amp;#34;:&amp;#34;2006-01-02T15:04:05Z&amp;#34;} } 通过 tag 为结构体字段编写元信息，这是 go 语言的语法，并在运行时通过反射解析。
json tag 的编写规则 标准库 encoding/json 规定了 json tag 的编写规则："><link rel="shortcut icon" href=/favicon.ico><script async src="https://www.googletagmanager.com/gtag/js?id=G-C0BX1J3KRG"></script><script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-C0BX1J3KRG",{anonymize_ip:!1})}</script><script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Noto+Serif+HK:wght@300;400;500;600;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script><script src=https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js></script></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label=切换菜单>
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=/img/avatar_hueb4763c82ba1420a58a50c6eccfe357b_472983_300x0_resize_box_3.png width=300 height=300 class=site-logo loading=lazy alt=Avatar>
</a><span class=emoji>☕</span></figure><div class=site-meta><h1 class=site-name><a href=/>雾封的笔</a></h1><h2 class=site-description>脚步不停，灿若繁星。</h2></div></header><ol class=social-menu><li><a href=mailto:zwei.elen@outlook.com target=_blank title=Email rel=me><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="#2c3e50" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" class="icon icon-tabler icon-tabler-mail" viewBox="0 0 24 24"><path stroke="none" d="M0 0h24v24H0z"/><path d="M3 7a2 2 0 012-2h14a2 2 0 012 2v10a2 2 0 01-2 2H5a2 2 0 01-2-2V7z"/><path d="m3 7 9 6 9-6"/></svg></a></li><li><a href=https://github.com/niluan304 target=_blank title=GitHub rel=me><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg></a></li></ol><ol class=menu id=main-menu><li><a href=/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg>
<span>Home</span></a></li><li><a href=/solutions/><!doctype html><svg t="1710685833984" class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" p-id="19816" xmlns:xlink="http://www.w3.org/1999/xlink" width="200" height="200"><path d="M624.289 816.93c-3.032.0-6.157.409-9.288 1.214-72.38 18.637-144.767 37.274-217.147 55.897-19.536 5.03-26.426 21.93-24.586 36.448 1.981 15.646 14.106 31.485 33.446 31.485h.002c3.029.0 6.15-.407 9.28-1.212a2055574.5 2055574.5.0 01217.149-55.898c19.536-5.034 26.423-21.938 24.583-36.457-1.985-15.642-14.106-31.476-33.44-31.476zM572.377 934.011c-6.321.0-12.516 2.06-18.413 6.126-14.42 9.939-28.264 15.35-41.153 16.086-.547.032-1.095.047-1.644.047-6.968.0-14.874-2.326-24.868-7.31-.743-.393-3.643-2.292-5.561-3.547-5.306-3.474-6.786-4.443-8.492-4.674-5.036-2.597-10.51-3.946-16.135-3.946-15.808.0-30.932 10.543-35.963 25.07-4.172 12.041-.206 24.313 10.609 32.827 24.347 19.168 52.743 29.3 82.12 29.3 26.81.0 53.386-8.55 76.855-24.725 13.26-9.139 18.484-24.493 13.637-40.068-4.69-15.065-17.144-25.186-30.992-25.186zM758.2 323.388c-23.674-44.276-59.272-80.43-102.949-104.556-40.902-22.593-88.289-34.536-137.036-34.536-41.49.0-83.246 8.797-120.754 25.442-39.792 17.658-73.83 43.216-101.172 75.963-51.182 61.3-72.758 149.987-57.716 237.237 14.454 83.839 60.433 154.192 126.145 193.017 5.63 3.328 11.493 5.015 17.423 5.015 15.057.0 28.606-11.094 32.946-26.978 4.146-15.17-1.767-29.61-15.431-37.682-87.857-51.928-112.807-177.156-85.54-263.399 26.457-83.656 107.442-139.862 201.52-139.862 39.74.0 78.37 10.246 111.716 29.63 45.121 26.234 77.406 69.951 90.905 123.098 14.556 57.308 5.738 118.382-24.192 167.566-11.93 19.606-27.417 37.625-42.396 55.048-9.603 11.173-19.533 22.724-28.549 34.697-15.429 20.492-20.147 42.395-24.71 63.575-.8 3.718-1.62 7.528-2.499 11.339l-198.107 52.663c-19.536 5.193-26.361 22.222-24.458 36.791 2.024 15.5 14.071 31.193 33.179 31.196h.007c3.103.0 6.304-.433 9.517-1.286 51.509-13.699 103.021-27.39 154.534-41.075 5.775-1.536 11.35-2.909 16.74-4.24 42.26-10.416 75.638-18.644 79.547-79.646 1.383-21.58 19.882-41.685 36.204-59.424 4.189-4.553 8.144-8.853 11.756-13.099 19.584-23.002 44.049-54.132 59.531-90.99 32.646-77.76 26.907-164.947-16.16-245.504zM173.191 470.702c0-19.056-15.448-34.504-34.505-34.504H71.708c-19.057.0-34.505 15.448-34.505 34.504.0 19.057 15.448 34.505 34.505 34.505h66.978c19.057.0 34.505-15.448 34.505-34.505zm781.798-34.504h-66.98c-19.056.0-34.503 15.448-34.503 34.504.0 19.057 15.448 34.505 34.504 34.505h66.979c19.056.0 34.505-15.448 34.505-34.505.0-19.056-15.449-34.504-34.505-34.504zM225.263 230.175c13.475 13.475 35.321 13.475 48.796.0s13.475-35.322.0-48.796l-47.362-47.362c-13.474-13.475-35.321-13.475-48.796.0s-13.475 35.321.0 48.796l47.362 47.362zM803.912 711.23c-13.475-13.475-35.322-13.475-48.797.0-13.474 13.475-13.474 35.322.0 48.797l47.362 47.362c13.475 13.475 35.322 13.475 48.796.0 13.475-13.475 13.475-35.321.0-48.797l-47.361-47.362zM514.587 135.988c19.056.0 34.505-15.449 34.505-34.505v-66.98C549.092 15.449 533.643.0 514.587.0c-19.057.0-34.505 15.449-34.505 34.505v66.979c0 19.056 15.448 34.505 34.505 34.505zM274.06 711.23c-13.475-13.475-35.321-13.475-48.796.0l-47.362 47.362c-13.475 13.475-13.475 35.321.0 48.797 13.475 13.475 35.322 13.475 48.796.0l47.362-47.362c13.475-13.475 13.475-35.322.0-48.797zM755.114 230.175c13.475 13.475 35.322 13.475 48.797.0l47.361-47.362c13.475-13.475 13.475-35.321.0-48.796s-35.321-13.475-48.796.0l-47.362 47.362c-13.474 13.474-13.474 35.321.0 48.796z" fill="#707070" p-id="19817" data-spm-anchor-id="a313x.search_index.0.i7.774c3a81Q659h0" class="selected"/></svg>
<span>Solutions</span></a></li><li><a href=/archives/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg>
<span>Archives</span></a></li><li><a href=/search/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg>
<span>Search</span></a></li><li><a href=/links/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M10 14a3.5 3.5.0 005 0l4-4a3.5 3.5.0 00-5-5l-.5.5"/><path d="M14 10a3.5 3.5.0 00-5 0l-4 4a3.5 3.5.0 005 5l.5-.5"/></svg>
<span>Links</span></a></li><li class=menu-bottom-section><ol class=menu><li id=dark-mode-toggle><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<span>暗色模式</span></li></ol></li></ol></aside><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">目录</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#基本的序列化和反序列化>基本的序列化和反序列化</a><ol><li><a href=#json-tag-的编写规则><code>json tag</code> 的编写规则</a></li></ol></li><li><a href=#自定义-json-的编解码实现>自定义 JSON 的编解码实现</a><ol><li><a href=#动态添加字段>动态添加字段</a></li><li><a href=#修改字段序列化格式>修改字段序列化格式</a></li><li><a href=#敏感字段处理>敏感字段处理</a></li></ol></li></ol></nav></div></section></aside><main class="main full-width"><article class=main-article><header class=article-header><div class=article-details><header class=article-category><a href=/categories/go/ style=background-color:#2a9d8f;color:#fff>Go</a></header><div class=article-title-wrapper><h2 class=article-title><a href=/p/json-%E6%A0%87%E5%87%86%E5%BA%93%E7%9A%84%E4%BD%BF%E7%94%A8%E6%8A%80%E5%B7%A7/>JSON 标准库的使用技巧</a></h2></div><footer class=article-time><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published>2025-03-09</time></div></footer></div></header><section class=article-content><p><code>encoding/json/v2</code> 即将在 go1.25 作为实验特性推出，真的非常让人期待。笔者回顾日常开发中，对 v1(<code>encoding/json</code>) 的使用，顺势总结了一些的技巧，而经过测试，这些技巧在 <code>encoding/json/v2</code> 仍然是有效的，这同样让笔者非常开心。</p><blockquote><p>关于 v2 的相关介绍，可查看：<a class=link href=https://tonybai.com/2025/05/15/go-json-v2/ target=_blank rel=noopener>手把手带你玩转GOEXPERIMENT=jsonv2：Go下一代JSON库初探 | Tony Bai</a></p></blockquote><h2 id=基本的序列化和反序列化>基本的序列化和反序列化</h2><p>先简单回顾下 JSON 这种数据交换格式在 go 中的使用：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>User</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>UserId</span>   <span class=kt>int64</span>     <span class=s>`json:&#34;userId&#34;`</span>
</span></span><span class=line><span class=cl>	<span class=nx>Password</span> <span class=kt>string</span>    <span class=s>`json:&#34;password&#34;`</span>
</span></span><span class=line><span class=cl>	<span class=nx>Birthday</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Time</span> <span class=s>`json:&#34;birthday&#34;`</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>user</span> <span class=o>:=</span> <span class=nx>User</span><span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>UserId</span><span class=p>:</span>   <span class=mi>20060102150405</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>Password</span><span class=p>:</span> <span class=s>&#34;zwei&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>Birthday</span><span class=p>:</span> <span class=nx>time</span><span class=p>.</span><span class=nf>Unix</span><span class=p>(</span><span class=mi>1136214245</span><span class=p>,</span> <span class=mi>0</span><span class=p>),</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>data</span><span class=p>,</span> <span class=nx>_</span> <span class=o>:=</span> <span class=nx>json</span><span class=p>.</span><span class=nf>Marshal</span><span class=p>(</span><span class=nx>user</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=nb>string</span><span class=p>(</span><span class=nx>data</span><span class=p>))</span>
</span></span><span class=line><span class=cl>	<span class=c1>// {&#34;userId&#34;:20060102150405,&#34;password&#34;:&#34;zwei&#34;,&#34;birthday&#34;:&#34;2006-01-02T15:04:05Z&#34;}
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span></code></pre></div><p>通过 <code>tag</code> 为结构体字段编写元信息，这是 go 语言的语法，并在运行时通过反射解析。</p><h3 id=json-tag-的编写规则><code>json tag</code> 的编写规则</h3><p>标准库 <code>encoding/json</code> 规定了 <code>json tag</code> 的编写规则：</p><ol><li>如果值为 <code>-</code> ，意味着跳过该字段的解析：<code>json:"-"</code>。</li><li>公有的结构体字段才会被解析。未导出的字段，即便有 <code>json tag</code>，也无法生效。</li><li>tag 的语法为：<code>json:"${name},${opt1},${opt2}"</code>。</li></ol><p>其中 <code>${name}</code> 用于指定 JSON 的键名，如果为空，取结构体字段名。此外，标准库还提供了可选项，用于开发者控制 JSON 编解码的结果。</p><ul><li>以 <code>,</code> 分割选项，可以没有选项，也可以有多个选项。目前的选项可选值为 <code>string</code>, <code>omitempty</code>, <code>omitzero</code> 这 3 个。</li><li>选项 <code>string</code>，表示该字段生成的 json键值的类型是字符串，这个选项只对 整型、浮点型、布尔型、字符型有效。</li><li>选项 <code>omitempty</code> 表示如果该字段为空值，生成的 JSON 键值对将会被忽略。</li><li>选项 <code>omitzero</code> 表示如果该字段为零值，生成的 JSON 键值对将会被忽略。</li></ul><p>上述的规则，都能够从标准库的源码 <a class=link href=https://github.com/golang/go/blob/d184f8dc020ac635cea02c046ab1d0b87dfd624d/src/encoding/json/encode.go#L1114-L1175 target=_blank rel=noopener>/src/encoding/json/encode.go</a> 中找到对应的解析过程：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>sf</span> <span class=o>:=</span> <span class=nx>f</span><span class=p>.</span><span class=nx>typ</span><span class=p>.</span><span class=nf>Field</span><span class=p>(</span><span class=nx>i</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=o>...</span>
</span></span><span class=line><span class=cl><span class=c1>// 跳过结构体未导出的字段
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>if</span> <span class=p>!</span><span class=nx>sf</span><span class=p>.</span><span class=nf>IsExported</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>   <span class=k>continue</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=o>...</span>
</span></span><span class=line><span class=cl><span class=nx>tag</span> <span class=o>:=</span> <span class=nx>sf</span><span class=p>.</span><span class=nx>Tag</span><span class=p>.</span><span class=nf>Get</span><span class=p>(</span><span class=s>&#34;json&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=nx>tag</span> <span class=o>==</span> <span class=s>&#34;-&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>   <span class=k>continue</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=c1>// 解析 json tag 的值，获取字段名和拓展选项
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>name</span><span class=p>,</span> <span class=nx>opts</span> <span class=o>:=</span> <span class=nf>parseTag</span><span class=p>(</span><span class=nx>tag</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=o>...</span>
</span></span><span class=line><span class=cl><span class=c1>// 只有 strings, floats, integers, and booleans 才可以被 &#34;&#34; 包裹.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>quoted</span> <span class=o>:=</span> <span class=kc>false</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=nx>opts</span><span class=p>.</span><span class=nf>Contains</span><span class=p>(</span><span class=s>&#34;string&#34;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>   <span class=k>switch</span> <span class=nx>ft</span><span class=p>.</span><span class=nf>Kind</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>   <span class=k>case</span> <span class=nx>reflect</span><span class=p>.</span><span class=nx>Bool</span><span class=p>,</span> <span class=nx>reflect</span><span class=p>.</span><span class=nx>Int</span><span class=p>,</span> <span class=nx>reflect</span><span class=p>.</span><span class=nx>String</span><span class=p>,</span> <span class=o>...</span><span class=p>:</span>
</span></span><span class=line><span class=cl>      <span class=nx>quoted</span> <span class=p>=</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl>   <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>...</span>
</span></span><span class=line><span class=cl><span class=c1>// 如果 json tag 的值为空, 取结构体字段名
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>if</span> <span class=nx>name</span> <span class=o>==</span> <span class=s>&#34;&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>   <span class=nx>name</span> <span class=p>=</span> <span class=nx>sf</span><span class=p>.</span><span class=nx>Name</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=nx>field</span> <span class=o>:=</span> <span class=nx>field</span><span class=p>{</span>
</span></span><span class=line><span class=cl>   <span class=nx>name</span><span class=p>:</span>      <span class=nx>name</span><span class=p>,</span>
</span></span><span class=line><span class=cl>   <span class=nx>omitEmpty</span><span class=p>:</span> <span class=nx>opts</span><span class=p>.</span><span class=nf>Contains</span><span class=p>(</span><span class=s>&#34;omitempty&#34;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>   <span class=nx>omitZero</span><span class=p>:</span>  <span class=nx>opts</span><span class=p>.</span><span class=nf>Contains</span><span class=p>(</span><span class=s>&#34;omitzero&#34;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>   <span class=nx>quoted</span><span class=p>:</span>    <span class=nx>quoted</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p><code>omitempty</code> 选项是 go1.1 版本就提供的功能，用于跳过空值的字段。但由于预定义的空值判断，无法满足所有实际场景的需求，因此在 go1.24 的时候，引入 <code>omitzero</code> 选项。具体的可查阅：<a class=link href=https://tonybai.com/2024/09/12/solve-the-empty-value-dilemma-in-json-encoding-with-omitzero/ target=_blank rel=noopener>JSON包新提案：用“omitzero”解决编码中的空值困局 | Tony Bai</a></p><blockquote><p>希望 JSON 标准库能够提供一个接口，用于指定 <code>json tag</code> 为空时的键名规则，而不是默认使用结构体字段值，这样可以少写很多 <code>json tag</code>。</p></blockquote><h2 id=自定义-json-的编解码实现>自定义 JSON 的编解码实现</h2><p>JSON 标准库提供了 Marshaler 和 Unmarshaler 这两个接口定义：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>Marshaler</span> <span class=kd>interface</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nf>MarshalJSON</span><span class=p>()</span> <span class=p>([]</span><span class=kt>byte</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>Unmarshaler</span> <span class=kd>interface</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nf>UnmarshalJSON</span><span class=p>([]</span><span class=kt>byte</span><span class=p>)</span> <span class=kt>error</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>如果在序列化和反序列化的过程中，JSON 标准库检测到类型实现了上述接口，那么就会使用接口的方法进行编解码，这也为 JSON 的编解码提供更多的功能，下面笔者将会介绍相关的应用技巧。</p><p>使用的例子都以 <code>User</code> 结构体为原型：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>User</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>UserId</span>   <span class=kt>int64</span>     <span class=s>`json:&#34;userId&#34;`</span>
</span></span><span class=line><span class=cl>	<span class=nx>Password</span> <span class=kt>string</span>    <span class=s>`json:&#34;password&#34;`</span>
</span></span><span class=line><span class=cl>	<span class=nx>Birthday</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Time</span> <span class=s>`json:&#34;birthday&#34;`</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h3 id=动态添加字段>动态添加字段</h3><p>如果我们希望得到的 JSON 对象还包含 <code>"age": ${age}</code> 这个键值对，<code>age</code> 表示当前用户的年龄，应该根据当前时间 <code>time.Now</code> 减去 <code>User.Birthday</code> 得到。很明显，为 <code>User</code> 结构体增加 <code>Age</code> 字段会增加维护成本，这时候为 <code>User</code> 结构体实现标准库定义的 <code>json.Marshaler</code> 接口，就可以一劳永逸：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>u</span> <span class=nx>User</span><span class=p>)</span> <span class=nf>MarshalJSON</span><span class=p>()</span> <span class=p>([]</span><span class=kt>byte</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=kd>type</span> <span class=nx>Format</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>UserId</span>   <span class=kt>int64</span>  <span class=s>`json:&#34;userId&#34;`</span>
</span></span><span class=line><span class=cl>		<span class=nx>Password</span> <span class=kt>string</span> <span class=s>`json:&#34;password&#34;`</span>
</span></span><span class=line><span class=cl>		<span class=nx>Age</span>      <span class=kt>int</span>    <span class=s>`json:&#34;age&#34;`</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>age</span> <span class=o>:=</span> <span class=nx>time</span><span class=p>.</span><span class=nf>Now</span><span class=p>().</span><span class=nf>Year</span><span class=p>()</span> <span class=o>-</span> <span class=nx>u</span><span class=p>.</span><span class=nx>Birthday</span><span class=p>.</span><span class=nf>Year</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>time</span><span class=p>.</span><span class=nf>Now</span><span class=p>().</span><span class=nf>YearDay</span><span class=p>()</span> <span class=p>&lt;</span> <span class=nx>u</span><span class=p>.</span><span class=nx>Birthday</span><span class=p>.</span><span class=nf>YearDay</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>age</span><span class=o>--</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>json</span><span class=p>.</span><span class=nf>Marshal</span><span class=p>(</span><span class=nx>Format</span><span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>UserId</span><span class=p>:</span>   <span class=nx>u</span><span class=p>.</span><span class=nx>UserId</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>Password</span><span class=p>:</span> <span class=nx>u</span><span class=p>.</span><span class=nx>Password</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>Age</span><span class=p>:</span>      <span class=nx>age</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=p>})</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>user</span> <span class=o>:=</span> <span class=nx>User</span><span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>UserId</span><span class=p>:</span>   <span class=mi>20060102150405</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>Password</span><span class=p>:</span> <span class=s>&#34;zwei&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>Birthday</span><span class=p>:</span> <span class=nx>time</span><span class=p>.</span><span class=nf>Unix</span><span class=p>(</span><span class=mi>1136214245</span><span class=p>,</span> <span class=mi>0</span><span class=p>),</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>data</span><span class=p>,</span> <span class=nx>_</span> <span class=o>:=</span> <span class=nx>json</span><span class=p>.</span><span class=nf>Marshal</span><span class=p>(</span><span class=nx>user</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=nb>string</span><span class=p>(</span><span class=nx>data</span><span class=p>))</span>
</span></span><span class=line><span class=cl>	<span class=c1>// {&#34;userId&#34;:20060102150405,&#34;password&#34;:&#34;zwei&#34;,&#34;age&#34;:19}
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span></code></pre></div><p>如果字段比较多，全部重写就比较麻烦了，这时候可以通过「类型定义」和「结构体内嵌」的方式来简化：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>u</span> <span class=nx>User</span><span class=p>)</span> <span class=nf>MarshalJSON</span><span class=p>()</span> <span class=p>([]</span><span class=kt>byte</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=kd>type</span> <span class=nx>NewUser</span> <span class=nx>User</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=kd>type</span> <span class=nx>Format</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>NewUser</span>
</span></span><span class=line><span class=cl>		<span class=nx>Age</span> <span class=kt>int</span> <span class=s>`json:&#34;age&#34;`</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>age</span> <span class=o>:=</span> <span class=nx>time</span><span class=p>.</span><span class=nf>Now</span><span class=p>().</span><span class=nf>Year</span><span class=p>()</span> <span class=o>-</span> <span class=nx>u</span><span class=p>.</span><span class=nx>Birthday</span><span class=p>.</span><span class=nf>Year</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>time</span><span class=p>.</span><span class=nf>Now</span><span class=p>().</span><span class=nf>YearDay</span><span class=p>()</span> <span class=p>&lt;</span> <span class=nx>u</span><span class=p>.</span><span class=nx>Birthday</span><span class=p>.</span><span class=nf>YearDay</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>age</span><span class=o>--</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>json</span><span class=p>.</span><span class=nf>Marshal</span><span class=p>(</span><span class=nx>Format</span><span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>NewUser</span><span class=p>:</span> <span class=nf>NewUser</span><span class=p>(</span><span class=nx>u</span><span class=p>),</span>
</span></span><span class=line><span class=cl>		<span class=nx>Age</span><span class=p>:</span>   <span class=nx>age</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=p>})</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>这里之所以使用类型定义：<code>type NewUser User</code>，是因为 <code>Format</code> 直接内嵌 <code>User</code> 结构体的话，就会继承其 <code>MarshalJSON</code> 的方法，那么就会陷入无限循环中，最后导致栈溢出。而使用类型定义，只会复用原始结构体字段，而不会继承其方法。</p><blockquote><p>go 官方文档里就很明确的提到了这一点：<a class=link href=https://go.dev/ref/spec#Type_definitions target=_blank rel=noopener>Type_definitions</a></p></blockquote><h3 id=修改字段序列化格式>修改字段序列化格式</h3><p><code>User.Birthday</code> 的类型为 <code>time.Time</code>，JSON 标准库只会序列化为 RFC3339 格式（<code>time.RFC3339 = "2006-01-02T15:04:05Z07:00"</code>），如果需要序列化为时间戳或其他格式，在实现 <code>json.Marshaler</code> 接口时，效仿 <a class=link href=#%e4%bf%ae%e6%94%b9-json-%e9%94%ae%e5%80%bc%e7%9a%84%e7%b1%bb%e5%9e%8b>修改键值类型</a> 的操作，即可实现：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>u</span> <span class=o>*</span><span class=nx>User</span><span class=p>)</span> <span class=nf>MarshalJSON</span><span class=p>()</span> <span class=p>([]</span><span class=kt>byte</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=kd>type</span> <span class=nx>NewUser</span> <span class=nx>User</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=kd>type</span> <span class=nx>Format</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=o>*</span><span class=nx>NewUser</span>
</span></span><span class=line><span class=cl>		<span class=nx>Birthday</span> <span class=kt>int64</span> <span class=s>`json:&#34;birthday&#34;`</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>json</span><span class=p>.</span><span class=nf>Marshal</span><span class=p>(</span><span class=nx>Format</span><span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>NewUser</span><span class=p>:</span>    <span class=p>(</span><span class=o>*</span><span class=nx>NewUser</span><span class=p>)(</span><span class=nx>u</span><span class=p>),</span>
</span></span><span class=line><span class=cl>		<span class=nx>Birthday</span><span class=p>:</span> <span class=nx>u</span><span class=p>.</span><span class=nx>Birthday</span><span class=p>.</span><span class=nf>Unix</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>	<span class=p>})</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>重新运行程序：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>user</span> <span class=o>:=</span> <span class=nx>User</span><span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>UserId</span><span class=p>:</span>   <span class=mi>20060102150405</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>Password</span><span class=p>:</span> <span class=s>&#34;zwei&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>Birthday</span><span class=p>:</span> <span class=nx>time</span><span class=p>.</span><span class=nf>Unix</span><span class=p>(</span><span class=mi>1136214245</span><span class=p>,</span> <span class=mi>0</span><span class=p>),</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>data</span><span class=p>,</span> <span class=nx>_</span> <span class=o>:=</span> <span class=nx>json</span><span class=p>.</span><span class=nf>Marshal</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>user</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=nb>string</span><span class=p>(</span><span class=nx>data</span><span class=p>))</span>
</span></span><span class=line><span class=cl>	<span class=c1>// {&#34;userId&#34;:20060102150405,&#34;password&#34;:&#34;zwei&#34;,&#34;birthday&#34;:1136214245}
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span></code></pre></div><p>可以看到 <code>Format.Birthday</code> 成功覆盖了 <code>Format.NewUser.Birthday</code>，这是因为外层的字段优先级更高。具体缘由，读者可以在标准库的源码中查看：<a class=link href=https://github.com/golang/go/blob/d184f8dc020ac635cea02c046ab1d0b87dfd624d/src/encoding/json/encode.go#L1259-L1284 target=_blank rel=noopener>encoding/json/encode.go</a></p><blockquote><p>当前部分的接口实现和 <a class=link href=#%e4%bf%ae%e6%94%b9-json-%e9%94%ae%e5%80%bc%e7%9a%84%e7%b1%bb%e5%9e%8b>修改键值类型</a> 的略有不同，笔者将值接收者 <code>func (u User)</code> 改成了指针接收者 <code>func (u *User)</code>，这也导致了 <code>json.Marshal(user)</code> 需要写成 <code>json.Marshal(&amp;user)</code>。</p><p>用于体现了「值接收」和「指针接收」的区别，具体的可查看 go 团队的 FAQ ：<a class=link href=https://go.dev/doc/faq#different_method_sets target=_blank rel=noopener>Why do T and *T have different method sets?</a></p></blockquote><h3 id=敏感字段处理>敏感字段处理</h3><p>在前面的例子中，实现了字段的新增和修改，这一部分则是介绍如何隐藏 JSON 的键值对。像密码 <code>Password</code> 作为敏感数据，是不应该返回到前端的，但仍然需要反序列化，因此不能使用 <code>json:"-"</code>，因为这个 tag 会直接跳过 <code>Password</code> 的反序列化。那么就可以在实现接口时，将 <code>Password</code> 的值置空：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>u</span> <span class=nx>User</span><span class=p>)</span> <span class=nf>MarshalJSON</span><span class=p>()</span> <span class=p>([]</span><span class=kt>byte</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=kd>type</span> <span class=nx>NewUser</span> <span class=nx>User</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>newUser</span> <span class=o>:=</span> <span class=nf>NewUser</span><span class=p>(</span><span class=nx>u</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>newUser</span><span class=p>.</span><span class=nx>Password</span> <span class=p>=</span> <span class=s>&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>json</span><span class=p>.</span><span class=nf>Marshal</span><span class=p>(</span><span class=nx>newUser</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>但也有不足之处，如果有多个结构体都含有 <code>Password</code> 字段，那么修改起来就变得非常繁琐了。</p><p>那么在介绍解决办法之前，还请读者做个题，下面代码的运行结果为：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=kd>var</span> <span class=nx>password</span> <span class=o>*</span><span class=kt>string</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>err1</span> <span class=o>:=</span> <span class=nx>json</span><span class=p>.</span><span class=nf>Unmarshal</span><span class=p>([]</span><span class=nb>byte</span><span class=p>(</span><span class=s>`&#34;zwei&#34;`</span><span class=p>),</span> <span class=o>&amp;</span><span class=nx>password</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err1</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nb>panic</span><span class=p>(</span><span class=nx>err1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>output</span><span class=p>,</span> <span class=nx>err2</span> <span class=o>:=</span> <span class=nx>json</span><span class=p>.</span><span class=nf>Marshal</span><span class=p>(</span><span class=o>*</span><span class=nx>password</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err2</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nb>panic</span><span class=p>(</span><span class=nx>err2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=nb>string</span><span class=p>(</span><span class=nx>output</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// 上面代码在尝试对字符串进行 json.Unmarshal 和 json.Marshal
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// 看有几种可能：
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// A. err1 != nil &amp;&amp; panic(err1)
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// B. *password -&gt; panic: nil pointer
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// C. err2 != nil &amp;&amp; panic(err2)
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// D. fmt.Println(string(output))
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span></code></pre></div><p>假设程序能够正常运行，这对置空 <code>Password</code> 的实现会有什么帮助呢？</p><p>一个简单的想法，如果能为 <code>Password</code> 实现 <code>json.Marshaler</code> 接口，将序列化的值设置为空字符串，就不用担心 <code>Password</code> 的泄露了。</p><p>而事实上，上述代码是能够正常运行的，因为字符串本就是 JSON 的数据类型，所以字符串也是可以被序列化和反序列化的。上面的代码在执行：<code>json.Unmarshal</code> 后，<code>password</code> 的值就是 <code>zwei</code> 了。再执行 <code>json.Marshal</code>，就会序列化为 <code>"zwei"</code>，这也就是 <code>output</code> 的值。</p><p>为了帮助 <code>Password</code> 实现 <code>json.Marshaler</code> 接口，需要先定义 <code>type Password string</code>，因为 <code>string</code> 作为内置类型，不支持为其编写方法。</p><p>具体实现也极其简单：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>Password</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>p</span> <span class=nx>Password</span><span class=p>)</span> <span class=nf>MarshalJSON</span><span class=p>()</span> <span class=p>([]</span><span class=kt>byte</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=p>[]</span><span class=nb>byte</span><span class=p>(</span><span class=s>`&#34;&#34;`</span><span class=p>),</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>通过这样实现 <code>Password</code> 的隐藏，也更贴近设计模式中的单一职责。为 <code>Password</code> 拓展功能也会变得更加简单，比如实现标准库的 <code>sql.Scanner</code> (<a class=link href=https://github.com/golang/go/blob/d184f8dc020ac635cea02c046ab1d0b87dfd624d/src/database/sql/sql.go#L446-L467 target=_blank rel=noopener>database/sql.go</a>) 接口 和 <code>driver.Valuer</code> (<a class=link href=https://github.com/golang/go/blob/d184f8dc020ac635cea02c046ab1d0b87dfd624d/src/database/sql/driver/types.go#L35-L47 target=_blank rel=noopener>database/sql/types.go</a>) 接口，实现自动加密和解密。</p><p>笔者以 <code>driver.Valuer</code> 为例：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>import</span> <span class=s>&#34;golang.org/x/crypto/bcrypt&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>p</span> <span class=nx>Password</span><span class=p>)</span> <span class=nf>Value</span><span class=p>()</span> <span class=p>(</span><span class=nx>driver</span><span class=p>.</span><span class=nx>Value</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=nx>p</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>hash</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>bcrypt</span><span class=p>.</span><span class=nf>GenerateFromPassword</span><span class=p>([]</span><span class=nb>byte</span><span class=p>(</span><span class=nx>p</span><span class=p>),</span> <span class=nx>bcrypt</span><span class=p>.</span><span class=nx>DefaultCost</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nb>string</span><span class=p>(</span><span class=nx>hash</span><span class=p>),</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>当 <code>Password</code> 不为空时，就能转化为数据库所需要的加密字符串。</p></section><footer class=article-footer><section class=article-copyright><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg>
<span>Licensed under CC BY-NC-SA 4.0</span></section></footer><link rel=stylesheet href=https://fastly.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css integrity=sha384-n8MVd4RsNIU0tAv4ct0nTaAbDJwPJzDEaqSD1odI+WdtXRGWt2kTvGFasHpSy3SV crossorigin=anonymous><script src=https://fastly.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js integrity=sha384-XjKyOOlGwcjNTAIQHIpgOno0Hl1YQqzUOEleOLALmuqehneUG+vnGctmUb0ZY0l8 crossorigin=anonymous defer></script><script src=https://fastly.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js integrity=sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05 crossorigin=anonymous defer></script><script>window.addEventListener("DOMContentLoaded",()=>{renderMathInElement(document.querySelector(`.article-content`),{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1},{left:"\\(",right:"\\)",display:!1},{left:"\\[",right:"\\]",display:!0}],ignoredClasses:["gist"]})})</script></article><aside class=related-content--wrapper><h2 class=section-title>相关文章</h2><div class=related-content><div class="flex article-list--tile"><article><a href=/p/gee-web-day10-%E9%80%9A%E8%BF%87%E5%8F%8D%E5%B0%84%E6%9E%84%E9%80%A0%E8%A7%84%E8%8C%83%E8%B7%AF%E7%94%B1/><div class=article-details><h2 class=article-title>gee-web-day10 通过反射构造规范路由</h2></div></a></article><article><a href=/p/gee-web-day9-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E4%B8%8E%E8%A7%A3%E8%80%A6/><div class=article-details><h2 class=article-title>gee-web-day9 反序列化与解耦</h2></div></a></article><article><a href=/p/gee-web-day8-%E5%88%86%E5%B1%82%E8%AE%BE%E8%AE%A1%E7%9A%84%E5%BF%85%E8%A6%81%E6%80%A7/><div class=article-details><h2 class=article-title>gee-web-day8 分层设计的必要性</h2></div></a></article><article class=has-image><a href=/p/sort.slice-%E4%B8%8D%E9%80%82%E5%90%88%E9%83%A8%E5%88%86%E6%8E%92%E5%BA%8F/><div class=article-image><img src=/p/sort.slice-%E4%B8%8D%E9%80%82%E5%90%88%E9%83%A8%E5%88%86%E6%8E%92%E5%BA%8F/_huca69348bf10406e412f1d3e0ec3bf9be_11506_a2ac3eee2a10f36f6bdaa5af0adafef8.png width=250 height=150 loading=lazy alt="Featured image of post sort.Slice 不适合部分排序" data-hash="md5-XQb5BRXbpdqa90Te+fQ/8g=="></div><div class=article-details><h2 class=article-title>sort.Slice 不适合部分排序</h2></div></a></article></div></div></aside><script src=//cdn.jsdelivr.net/npm/twikoo@1.6.32/dist/twikoo.all.min.js></script><div id=tcomment></div><style>.twikoo{background-color:var(--card-background);border-radius:var(--card-border-radius);box-shadow:var(--shadow-l1);padding:var(--card-padding)}:root[data-scheme=dark]{--twikoo-body-text-color-main:rgba(255, 255, 255, 0.9);--twikoo-body-text-color:rgba(255, 255, 255, 0.7)}.twikoo .el-input-group__prepend,.twikoo .tk-action-icon,.twikoo .tk-submit-action-icon,.twikoo .tk-time,.twikoo .tk-comments-no,.twikoo .tk-comments-count{color:var(--twikoo-body-text-color)}.twikoo .el-input__inner,.twikoo .el-textarea__inner,.twikoo .tk-preview-container,.twikoo .tk-content,.twikoo .tk-nick,.twikoo .tk-send{color:var(--twikoo-body-text-color-main)}.twikoo .el-button{color:var(--twikoo-body-text-color)!important}.twikoo .el-input__count{color:var(--twikoo-body-text-color)!important}.OwO .OwO-body{background-color:var(--body-background)!important;color:var(--body-text-color)!important}</style><script>twikoo.init({envId:"https://zwei5702-twikoo.hf.space",el:"#tcomment"})</script><section class=totalcount>发表了9篇文章 ·
总计7.98k字</section><script>Array.from(document.getElementsByClassName("language-mermaid")).forEach(e=>{e.parentElement.outerHTML=`<div class="mermaid">${e.innerText}</div>`})</script><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://fastly.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://fastly.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://fastly.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://fastly.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://fastly.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.js defer></script><script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>